<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Test Implementation</title>
    <link rel="stylesheet" type="text/css" href="style/main.css">
</head>
<body>
<section class="c bodywidth">
    <h2>Select a Kitty!</h2>
    <ul class="c" style="width:150px;">
        <li class="s2">1
        <li class="s2">2
        <li class="s2">3
    </ul>
    <h2 class="cb">Delta Image:</h2>
    <p onClick="upgrader();" id="upgradeButton" class="s1 c" style="width:200px;margin:0 auto;">Upgrade</p>
    <img id="responsive" class="c" width="1024p×" height="512px" src="images/place_kitty_3_low.jpg" data-stage="0">
    <h2>Original:</h2>
    <img id="full" class="c" width="1024p×" height="512px" src="images/place_kitty_3.jpg">
</section>

<script>
var stage=0;

upgrader = function(){
    switch(++stage){
        case 1: upgrade(document.getElementById('responsive'),'images/place_kitty_3_low_to_med_diff.jpg');
                document.getElementById('upgradeButton').innerHTML = "Upgrade (again)";
                break;
        case 2: upgrade(document.getElementById('responsive'),'images/place_kitty_3_med_to_full_diff.jpg');
                document.getElementById('upgradeButton').innerHTML = "Done!";
                break;
        default: break;
    }
}

/*
    This is the important function
*/

upgrade = function(el, dsrc, cb){
	var canvas = document.createElement('canvas')
      , ctx = canvas.getContext('2d')
      , img2 = new Image()
      , data1
      , data2;
    img2.onload = function(){
        canvas.width = img2.width;
        canvas.height = img2.height;

        ctx.drawImage(el,0,0,img2.width,img2.height);
        data1 = ctx.getImageData(0,0,img2.width,img2.height);
    	ctx.drawImage(img2,0,0,img2.width,img2.height);
		data2 = ctx.getImageData(0,0,img2.width,img2.height);

        // Use the diff

        for(var i=0;i<img2.width*img2.height;i++){
            for(var j=0;j<3;j++){
                data1.data[4*i+j] = Math.min(255,Math.max(0,(data1.data[4*i+j]+((data2.data[4*i+j]-127) || 0))));
            }
        }

        ctx.putImageData(data1,0,0);
        el.src = ctx.canvas.toDataURL();

        if(cb) cb();
    };
    img2.src = dsrc;
};

/*
    This stuff is not important
*/

</script>
</body>
</html>